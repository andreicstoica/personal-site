---
import type { Experience } from "../../lib/types.ts";
import { experiences } from "../../lib/experience.ts";

// Get unique types for the filter dropdown
const allTypes = [...new Set(experiences.map(exp => exp.type))].sort();

// Color mapping for different experience types using CSS custom properties
const typeColors = {
  personal: '--tag-personal',
  work: '--tag-work',
  school: '--tag-school',
  other: '--tag-other'
};

// Text color mapping for better contrast with each background, irrespective of theme
const textColors = {
  personal: '272727',    // Dark text on bright green
  work: 'fefefe',        // White text on blue
  school: '272727',      // Dark text on yellow
  other: 'fefefe'        // White text on pink
};

// Helper function to get inline styles for a given type
const getTypeStyles = (type: string) => {
  const colorVar = typeColors[type as keyof typeof typeColors] || '--tag-other';
  const textColorVar = textColors[type as keyof typeof textColors] || '272727';
  return `background-color: var(${colorVar}); color: #${textColorVar}; box-decoration-break: clone; -webkit-box-decoration-break: clone; font-size: 0.875rem; font-weight: 500;`;
};

// Format date range
const formatDateRange = (startDate: string, endDate?: string) => {
  if (endDate && endDate !== '...') {
    return `${startDate}-${endDate}`;
  }
  return endDate === '...' ? `${startDate}-...` : startDate;
};
---

<section class="w-full text-(color-text-primary) dark:text-(color-text-inverse)">
  <!-- Table Header -->
  <div class="hidden lg:grid lg:grid-cols-10 gap-2 pb-3 border-b border-gray-200 dark:border-gray-700 font-semibold text-sm uppercase tracking-wider">
    <div class="col-span-1 text-sm">Experience</div>
    <div class="col-span-2 text-sm">Role</div>
    <div class="col-span-2 text-sm">
      <select id="typeFilter" class="w-full border max-w-30 border-gray-300 dark:border-gray-600 px-2 text-sm bg-transparent uppercase">
        <option value="">all</option>
        {allTypes.map(type => (
          <option value={type}>{type}</option>
        ))}
      </select>
    </div>
    <div class="col-span-1 text-sm">Date</div>
    <div class="col-span-4 text-sm">Media</div>
  </div>

  <!-- Table Body -->
  <div class="-space-y-0">
    {experiences.map((experience, index) => (
      <div class="experience-row border-b border-gray-200 dark:border-gray-700" data-type={experience.type}>
        <!-- Desktop Layout -->
        <div class="hidden lg:grid lg:grid-cols-10 gap-2 items-start">
          <!-- Experience Name (1 col) -->
          <div class="col-span-1 -mt-1">
            <span style={getTypeStyles(experience.type)}>
              {experience.name}
            </span>
          </div>

          <!-- Role (2 cols) -->
          <div class="col-span-2">
            <div class="text-sm">{experience.role}</div>
          </div>

          <!-- Tags (2 cols) -->
          <div class="col-span-2">
            <div class="font-serif text-sm">
              {experience.tags.join(', ')}
            </div>
          </div>

          <!-- Date (1 col) -->
          <div class="col-span-1">
            <div class="font-mono text-sm">
              {formatDateRange(experience.startDate, experience.endDate)}
            </div>
          </div>

          <!-- Media (4 cols) -->
          <div class="col-span-4">
            {experience.images && experience.images.length > 0 && (
              <div class="flex gap-2 overflow-x-auto">
                {experience.images.map((image, imgIndex) => (
                  <img
                    src={`/images/${image}`}
                    alt={`${experience.name} ${imgIndex + 1}`}
                    class="w-24 object-cover border border-gray-200 dark:border-gray-700 flex-shrink-0"
                    loading="lazy"
                  />
                ))}
              </div>
            )}
          </div>
        </div>

        <!-- Description (spans 4 cols, starting at col 2) -->
        {experience.description && (
          <div class="hidden lg:grid lg:grid-cols-10">
            <div class="col-span-1"></div> <!-- Empty space for experience column -->
            <div class="col-span-5"> <!-- Spans 4 columns starting from role column -->
              <p class="text-sm leading-relaxed">
                {experience.description}
              </p>
            </div>
            <div class="col-span-6"></div> <!-- Empty space for date and media columns -->
          </div>
        )}

        <!-- Mobile Layout -->
        <div class="lg:hidden">
          <div class="mb-3">
            <span class="mb-2" style={getTypeStyles(experience.type)}>
              {experience.name}
            </span>
            <h3 class="text-sm font-semibold">{experience.role}</h3>
            <p class="text-sm">
              {formatDateRange(experience.startDate, experience.endDate)}
            </p>
          </div>

          <div class="text-sm mb-3">
            {experience.tags.join(', ')}
          </div>

          {experience.description && (
            <p class="text-sm leading-relaxed">
              {experience.description}
            </p>
          )}

          {experience.images && experience.images.length > 0 && (
            <div class="flex gap-2 overflow-x-auto">
              {experience.images.map((image, imgIndex) => (
                <img
                  src={`/images/${image}`}
                  alt={`${experience.name} ${imgIndex + 1}`}
                  class="h-20 w-28 object-cover rounded border border-gray-200 dark:border-gray-700 flex-shrink-0"
                  loading="lazy"
                />
              ))}
            </div>
          )}
        </div>
      </div>
    ))}
  </div>
</section>

<script>
  // Filter functionality
  const filterSelect = document.getElementById('typeFilter') as HTMLSelectElement;
  const experienceRows = document.querySelectorAll('.experience-row');

  if (filterSelect) {
    filterSelect.addEventListener('change', (e) => {
      const selectedType = (e.target as HTMLSelectElement).value;

      experienceRows.forEach((row) => {
        const rowType = (row as HTMLElement).dataset.type;

        if (selectedType === '' || rowType === selectedType) {
          (row as HTMLElement).style.display = 'block';
        } else {
          (row as HTMLElement).style.display = 'none';
        }
      });
    });
  }
</script>
